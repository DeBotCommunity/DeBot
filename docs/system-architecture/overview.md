# Обзор компонентов

DeBot построен на модульной и асинхронной архитектуре, где каждый компонент выполняет свою четко определенную роль.

```mermaid
graph TD
    subgraph "Docker Environment"
        subgraph "Userbot Container (Python/Telethon)"
            Init["<b>userbot/__init__.py</b><br>Точка входа<br>Загружает аккаунты и сессии из БД<br>Запускает асинхронные задачи для каждого клиента"]
            Main["<b>userbot/__main__.py</b><br>Основной цикл событий<br>APScheduler для фоновых задач"]
            DBManager["<b>DB Manager (SQLAlchemy)</b><br>Слой для работы с БД<br>Все CRUD-операции"]
            Locales["<b>TranslationManager</b><br>Кэширует и предоставляет переводы из .json файлов"]
            
            subgraph "Для каждого аккаунта"
                TempSession["Temp .session file"]
                Client[("TelegramClient Instance")] -- "использует" --> TempSession
            end
        end

        DBContainer["<b>Database Container</b><br>(PostgreSQL)"]
    end

    User((Telegram User)) -- "Команды (.addacc, .help, ...)" --> Client
    Init -- "Читает аккаунты" --> DBManager
    Init -- "Создает" --> Client
    Init -- "Дешифрует сессию из БД и пишет в" --> TempSession
    DBManager -- "Подключается к" --> DBContainer
```

-   **`userbot/__init__.py` (Ядро)**: Это первая точка входа при запуске. Его задача — подключиться к базе данных, получить список всех **активных** аккаунтов (`is_enabled = True`). Для каждого аккаунта он выполняет следующие шаги:
    1.  Извлекает зашифрованный файл сессии из базы данных.
    2.  Дешифрует его.
    3.  Записывает содержимое во временный файл на диске.
    4.  Создает экземпляр стандартного `telethon.sessions.SQLiteSession`, указывая на этот временный файл.
    5.  Создает и запускает отдельную асинхронную задачу для `TelegramClient`, передавая ему эту сессию.
-   **`userbot/__main__.py` (Основной цикл)**: Этот файл содержит логику основного цикла событий и инициализирует `APScheduler` для выполнения фоновых задач (сборка мусора, автообновление).
-   **DB Manager (SQLAlchemy)**: Слой абстракции для работы с базой данных. Все функции для добавления, получения, обновления и удаления данных (аккаунтов, сессий, модулей) реализованы здесь с использованием SQLAlchemy ORM.
-   **TranslationManager**: Глобальный сервис, который отвечает за загрузку, кэширование и предоставление переведенных строк. Он обеспечивает мультиязычность во всем приложении.
-   **TelegramClient Instance**: Для каждого активного аккаунта создается свой собственный экземпляр кастомного класса `TelegramClient`, который наследуется от `telethon.TelegramClient`.
-   **Хранение сессии**: В отличие от стандартного подхода, DeBot не хранит `.session` файлы на диске постоянно. Весь SQLite файл сессии хранится в базе данных PostgreSQL в зашифрованном виде (в поле типа `BYTEA`). Это обеспечивает безопасность и централизованное хранение.
