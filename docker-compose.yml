version: '3.8'

services:
  userbot:
    build: .
    container_name: debot_userbot
    # Load environment variables from a .env file in the project root.
    # This file should contain API_ID, API_HASH, USERBOT_ENCRYPTION_KEY,
    # and PostgreSQL connection details (DB_HOST, DB_PORT, DB_USER, DB_PASS, DB_NAME).
    env_file:
      - .env
    # Restart policy to ensure the bot comes back up unless explicitly stopped.
    restart: unless-stopped
    volumes:
      # Persist custom modules downloaded via .addmod.
      # The path inside the container (/app/userbot/modules) must match
      # where the application expects to find/store them.
      # The Dockerfile sets WORKDIR /app, and the application logic stores modules
      # in "userbot/modules" relative to the project root.
      - ./userbot/modules:/app/userbot/modules
      # Note: Telethon session files are managed by DbSession via PostgreSQL,
      # so direct mapping of Telethon session files is not required here.
      # Database persistence should be handled by the PostgreSQL service itself.

  # Example PostgreSQL service (optional, if you want to run DB in Docker)
  # If you have an external PostgreSQL server, you don't need this.
  # Ensure DB_HOST in your .env points to 'db' if using this service.
  db:
    image: postgres:13-alpine
    container_name: debot_postgres
    environment:
      POSTGRES_USER: ${DB_USER:-userbot_user} # Use from .env or default
      POSTGRES_PASSWORD: ${DB_PASS:-userbot_pass} # Use from .env or default
      POSTGRES_DB: ${DB_NAME:-userbot_db} # Use from .env or default
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Expose PostgreSQL port to host if needed for external access/debugging.
      # Format: "HOST_PORT:CONTAINER_PORT"
      # Default PostgreSQL port is 5432.
      - "${DB_PORT_HOST:-5432}:5432" # Use DB_PORT_HOST from .env or default to 5432
    restart: unless-stopped

volumes:
  # Define a named volume for PostgreSQL data to persist it.
  postgres_data:

# Networks (optional, for more complex setups)
# networks:
#   debot_network:
#     driver: bridge

# To use this docker-compose.yml:
# 1. Make sure you have Docker and Docker Compose installed.
# 2. Create a .env file in the same directory with your API_ID, API_HASH, USERBOT_ENCRYPTION_KEY,
#    and database connection details (DB_HOST, DB_PORT, DB_USER, DB_PASS, DB_NAME).
#    If using the 'db' service above, DB_HOST should be 'db'.
# 3. Run 'docker-compose up -d --build' to build and start the userbot (and PostgreSQL if enabled).
# 4. To stop, run 'docker-compose down'.
# 5. To view logs, run 'docker-compose logs -f userbot' or 'docker-compose logs -f db'.
